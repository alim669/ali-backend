# ========================================
# Nginx Avatar/Image Caching Configuration
# ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ§ŸÇÿ™ ŸÑŸÑÿµŸàÿ±
# ========================================
#
# Add this to your main nginx config inside the server block
# or include it using: include /etc/nginx/conf.d/avatar-cache.conf;

# ========================================
# Image/Avatar Location with Premium Caching
# ========================================
location /uploads/avatars/ {
    alias /var/www/ali-backend/uploads/avatars/;
    
    # CORS Headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Range, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, ETag' always;
    
    # üõ°Ô∏è CRITICAL: Long-term caching with immutable flag
    # Avatars are saved with unique timestamps, so they can be cached forever
    expires 365d;
    add_header Cache-Control "public, max-age=31536000, immutable";
    
    # üõ°Ô∏è ETag for cache validation
    etag on;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Range, Authorization';
        add_header 'Access-Control-Max-Age' '86400';
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' '0';
        return 204;
    }
    
    # WebP negotiation - serve WebP if available and client supports it
    location ~* ^(/uploads/avatars/.+)\.(jpg|jpeg|png)$ {
        set $webp_uri $1.webp;
        
        # Check if WebP version exists and client supports it
        if ($http_accept ~* "webp") {
            # Try WebP first
            try_files $webp_uri $uri =404;
        }
        
        # Fallback to original
        try_files $uri =404;
    }
    
    try_files $uri =404;
}

# ========================================
# Room Images Location
# ========================================
location /uploads/rooms/ {
    alias /var/www/ali-backend/uploads/rooms/;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    
    # Long-term caching
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    etag on;
    
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        add_header 'Access-Control-Max-Age' '86400';
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' '0';
        return 204;
    }
    
    try_files $uri =404;
}

# ========================================
# General Uploads Location (fallback)
# ========================================
location /uploads/ {
    alias /var/www/ali-backend/uploads/;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Range, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Range, Authorization';
        add_header 'Access-Control-Max-Age' '86400';
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' '0';
        return 204;
    }
    
    # Standard caching for other uploads
    expires 7d;
    add_header Cache-Control "public";
    etag on;
    
    try_files $uri =404;
}
