generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                                                 String            @id @default(uuid())
  numericId                                          BigInt            @unique @default(autoincrement())
  customId                                           String?           @unique
  email                                              String            @unique
  passwordHash                                       String?
  googleId                                           String?           @unique
  authProvider                                       AuthProvider      @default(EMAIL)
  username                                           String            @unique
  displayName                                        String
  avatar                                             String?
  bio                                                String?
  role                                               UserRole          @default(USER)
  status                                             UserStatus        @default(ACTIVE)
  isVIP                                              Boolean           @default(false)
  vipExpiresAt                                       DateTime?
  emailVerified                                      Boolean           @default(false)
  lastLoginAt                                        DateTime?
  lastLoginIp                                        String?
  // Ban fields
  banReason                                          String?
  bannedAt                                           DateTime?
  bannedUntil                                        DateTime?
  bannedBy                                           String?
  createdAt                                          DateTime          @default(now())
  updatedAt                                          DateTime          @updatedAt
  adminActions                                       AdminAction[]     @relation("AdminActor")
  actionsReceived                                    AdminAction[]     @relation("AdminTarget")
  following                                          Follow[]          @relation("Follower")
  followers                                          Follow[]          @relation("Following")
  giftsReceived                                      GiftSend[]        @relation("GiftReceiver")
  giftsSent                                          GiftSend[]        @relation("GiftSender")
  sentMessages                                       Message[]         @relation("MessageSender")
  notifications                                      Notification[]
  refreshTokens                                      RefreshToken[]
  reportsReceived                                    Report[]          @relation("ReportedUser")
  reportsMade                                        Report[]          @relation("Reporter")
  reportsResolved                                    Report[]          @relation("ReportResolver")
  ownedRooms                                         Room[]            @relation("RoomOwner")
  roomMemberships                                    RoomMember[]
  wallet                                             Wallet?
  friend_requests_friend_requests_from_user_idToUser friend_requests[] @relation("friend_requests_from_user_idToUser")
  friend_requests_friend_requests_to_user_idToUser   friend_requests[] @relation("friend_requests_to_user_idToUser")
  friendships_friendships_user1_idToUser             friendships[]     @relation("friendships_user1_idToUser")
  friendships_friendships_user2_idToUser             friendships[]     @relation("friendships_user2_idToUser")
  // Private Messages
  sentPrivateMessages                                PrivateMessage[]  @relation("PrivateMessageSender")
  receivedPrivateMessages                            PrivateMessage[]  @relation("PrivateMessageReceiver")
  // Block System
  blockedUsers                                       UserBlock[]       @relation("Blocker")
  blockedByUsers                                     UserBlock[]       @relation("Blocked")
  // Device Tokens
  deviceTokens                                       DeviceToken[]
  // Agent Relations
  agentRequests                                      AgentRequest[]
  agent                                              Agent?
  // Verification Badge
  verification                                       Verification?
  // Explore Posts
  explorePosts                                       ExplorePost[]
  // Mute System
  mutesReceived                                      UserMute[]        @relation("MutedUser")
  mutesApplied                                       UserMute[]        @relation("MutedBy")
  // Appeals
  appeals                                            Appeal[]

  @@index([email])
  @@index([googleId])
  @@index([username])
  @@index([status])
  @@index([createdAt])
  @@index([numericId])
  @@index([isVIP, vipExpiresAt])
  @@index([customId])
}

model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     String
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Room {
  id                  String       @id @default(uuid())
  numericId           Int          @unique @default(autoincrement())
  name                String
  description         String?
  avatar              String?
  type                RoomType     @default(PUBLIC)
  status              RoomStatus   @default(ACTIVE)
  ownerId             String
  maxMembers          Int          @default(100)
  currentMembers      Int          @default(0)
  isPasswordProtected Boolean      @default(false)
  passwordHash        String?
  settings            Json?        // إعدادات الغرفة (isVip, vipExpiresAt, etc.)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  giftsSent           GiftSend[]
  messages            Message[]
  reports             Report[]
  owner               User         @relation("RoomOwner", fields: [ownerId], references: [id])
  members             RoomMember[]
  userMutes           UserMute[]

  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([numericId])
}

model RoomMember {
  id          String     @id @default(uuid())
  roomId      String
  userId      String
  role        MemberRole @default(MEMBER)
  isMuted     Boolean    @default(false)
  mutedUntil  DateTime?
  isBanned    Boolean    @default(false)
  bannedUntil DateTime?
  joinedAt    DateTime   @default(now())
  leftAt      DateTime?
  room        Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@index([role])
  @@index([isBanned, bannedUntil])
  @@index([isMuted, mutedUntil])
}

model Message {
  id         String      @id @default(uuid())
  roomId     String
  senderId   String
  type       MessageType @default(TEXT)
  content    String
  metadata   Json?
  giftSendId String?     @unique
  isDeleted  Boolean     @default(false)
  deletedAt  DateTime?
  deletedBy  String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  giftSend   GiftSend?   @relation(fields: [giftSendId], references: [id])
  room       Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender     User        @relation("MessageSender", fields: [senderId], references: [id])

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([roomId, createdAt])
  @@index([isDeleted])
}

model Gift {
  id           String     @id @default(uuid())
  name         String
  description  String?
  type         GiftType   @default(STANDARD)
  imageUrl     String
  animationUrl String?
  videoUrl     String?
  price        Int
  isActive     Boolean    @default(true)
  sortOrder    Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  giftSends    GiftSend[]

  @@index([type])
  @@index([isActive])
  @@index([sortOrder])
}

model GiftSend {
  id             String   @id @default(uuid())
  idempotencyKey String   @unique
  giftId         String
  senderId       String
  receiverId     String
  roomId         String?
  quantity       Int      @default(1)
  totalPrice     Int
  message        String?
  createdAt      DateTime @default(now())
  gift           Gift     @relation(fields: [giftId], references: [id])
  receiver       User     @relation("GiftReceiver", fields: [receiverId], references: [id])
  room           Room?    @relation(fields: [roomId], references: [id])
  sender         User     @relation("GiftSender", fields: [senderId], references: [id])
  chatMessage    Message?

  @@index([senderId])
  @@index([receiverId])
  @@index([roomId])
  @@index([giftId])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  balance      BigInt              @default(0)
  diamonds     BigInt              @default(0)
  version      Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
}

model WalletTransaction {
  id            String            @id @default(uuid())
  walletId      String
  type          TransactionType
  status        TransactionStatus @default(COMPLETED)
  amount        BigInt
  balanceBefore BigInt
  balanceAfter  BigInt
  referenceType String?
  referenceId   String?
  description   String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  wallet        Wallet            @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

model AdminAction {
  id        String          @id @default(uuid())
  actorId   String
  targetId  String?
  action    AdminActionType
  reason    String?
  details   Json?
  ipAddress String?
  createdAt DateTime        @default(now())
  actor     User            @relation("AdminActor", fields: [actorId], references: [id])
  target    User?           @relation("AdminTarget", fields: [targetId], references: [id])

  @@index([actorId])
  @@index([targetId])
  @@index([action])
  @@index([createdAt])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Report {
  id             String       @id @default(uuid())
  reporterId     String
  reportedUserId String?
  reportedRoomId String?
  type           ReportType
  status         ReportStatus @default(PENDING)
  reason         String
  details        String?
  resolvedById   String?
  resolution     String?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  reportedRoom   Room?        @relation(fields: [reportedRoomId], references: [id])
  reportedUser   User?        @relation("ReportedUser", fields: [reportedUserId], references: [id])
  reporter       User         @relation("Reporter", fields: [reporterId], references: [id])
  resolvedBy     User?        @relation("ReportResolver", fields: [resolvedById], references: [id])

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([reportedRoomId])
  @@index([status])
  @@index([createdAt])
}

model AgentRequest {
  id              String             @id @default(uuid())
  userId          String
  fullName        String
  country         String
  province        String
  region          String
  email           String
  phone           String
  telegram        String?
  message         String?
  status          AgentRequestStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  expiresAt       DateTime           @default(dbgenerated("(now() + '7 days'::interval)"))
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([expiresAt])
}

model Agent {
  id        String      @id @default(uuid())
  userId    String      @unique
  fullName  String
  country   String
  province  String
  region    String
  phone     String
  telegram  String?
  status    AgentStatus @default(ACTIVE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([country])
  @@index([createdAt])
}

model friend_requests {
  id                                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  from_user_id                            String
  to_user_id                              String
  status                                  String?   @default("pending") @db.VarChar(20)
  created_at                              DateTime? @default(now()) @db.Timestamp(6)
  updated_at                              DateTime? @default(now()) @db.Timestamp(6)
  User_friend_requests_from_user_idToUser User      @relation("friend_requests_from_user_idToUser", fields: [from_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User_friend_requests_to_user_idToUser   User      @relation("friend_requests_to_user_idToUser", fields: [to_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([from_user_id, to_user_id])
  @@index([from_user_id, status], map: "idx_friend_requests_from_user")
  @@index([to_user_id, status], map: "idx_friend_requests_to_user")
}

model friendships {
  id                              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user1_id                        String
  user2_id                        String
  created_at                      DateTime? @default(now()) @db.Timestamp(6)
  User_friendships_user1_idToUser User      @relation("friendships_user1_idToUser", fields: [user1_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User_friendships_user2_idToUser User      @relation("friendships_user2_idToUser", fields: [user2_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user1_id, user2_id])
  @@index([user1_id], map: "idx_friendships_user1")
  @@index([user2_id], map: "idx_friendships_user2")
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum RoomType {
  PUBLIC
  PRIVATE
  VIP
}

enum RoomStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum MemberRole {
  MEMBER
  MODERATOR
  ADMIN
  OWNER
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  GIFT
  SYSTEM
}

enum GiftType {
  STANDARD
  ANIMATED
  VIDEO_VIP
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  GIFT_SENT
  GIFT_RECEIVED
  PURCHASE
  REFUND
  ADMIN_ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum AdminActionType {
  USER_BANNED
  USER_SUSPENDED
  USER_UNBANNED
  USER_WARNING
  USER_MUTED
  USER_SHADOW_BANNED
  USER_IP_BANNED
  USER_FROZEN
  ROOM_CLOSED
  ROOM_SUSPENDED
  ROOM_DELETED
  ROOM_OWNERSHIP_TRANSFERRED
  GIFT_CREATED
  GIFT_UPDATED
  GIFT_REVERSED
  WALLET_ADJUSTED
  SETTINGS_CHANGED
  SETTING_CHANGED
  ROLE_CHANGED
  FORCE_LOGOUT
  FORCE_LOGOUT_ALL
  VERIFICATION_GRANTED
  VERIFICATION_REVOKED
}

enum NotificationType {
  GIFT_RECEIVED
  NEW_FOLLOWER
  ROOM_INVITE
  SYSTEM_MESSAGE
  MENTION
  LIKE
  COMMENT
  FRIEND_REQUEST_ACCEPTED
  FRIEND_REQUEST_RECEIVED
  POINTS_RECEIVED
  POINTS_DEDUCTED
  TRANSFER_RECEIVED
  TRANSFER_SENT
}

enum ReportType {
  SPAM
  HARASSMENT
  INAPPROPRIATE_CONTENT
  FAKE_ACCOUNT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum AgentRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ================================
// Private Messaging System
// ================================

model PrivateMessage {
  id          String               @id @default(uuid())
  senderId    String
  receiverId  String
  type        PrivateMessageType   @default(TEXT)
  content     String
  metadata    Json?
  status      PrivateMessageStatus @default(SENT)
  isDeleted   Boolean              @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  deliveredAt DateTime?
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  sender      User                 @relation("PrivateMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User                 @relation("PrivateMessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([senderId, receiverId])
  @@index([receiverId, status])
  @@index([createdAt])
}

enum PrivateMessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  GIFT
}

enum PrivateMessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ================================
// User Block System
// ================================

model UserBlock {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  reason    String?
  createdAt DateTime @default(now())
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// ================================
// User Mute System (Global & Room Mutes)
// ================================

model UserMute {
  id        String   @id @default(uuid())
  userId    String
  mutedById String
  reason    String?
  scope     String   @default("GLOBAL") // GLOBAL, ROOM
  roomId    String?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  user      User     @relation("MutedUser", fields: [userId], references: [id], onDelete: Cascade)
  mutedBy   User     @relation("MutedBy", fields: [mutedById], references: [id], onDelete: Cascade)
  room      Room?    @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mutedById])
  @@index([roomId])
  @@index([expiresAt])
}

// ================================
// Device Tokens for Push Notifications
// ================================

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  Platform @default(ANDROID)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, isActive])
}

enum Platform {
  ANDROID
  IOS
  WEB
}

// ================================
// Verification Badges System
// ================================

model Verification {
  id        String           @id @default(uuid())
  userId    String           @unique
  type      VerificationType
  price     Int              @default(0)
  expiresAt DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

enum VerificationType {
  BLUE
  GOLD
  PURPLE
  DIAMOND
  VIP        // توثيق VIP متحرك
  VERIFIED   // توثيق رسمي مثل فيسبوك - أزرق كلاسيكي
  OFFICIAL   // حساب رسمي للمؤسسات
  CELEBRITY  // توثيق المشاهير
}

// ================================
// Explore Posts (Reels) System
// ================================

model ExplorePost {
  id            String              @id @default(uuid())
  userId        String
  userName      String
  userHandle    String
  caption       String
  tags          String[]
  country       String              @default("IQ")
  locale        String              @default("ar")
  durationSec   Int?
  aspectRatio   Float?
  thumbnailUrl  String?
  mediaUrl      String?
  isReel        Boolean             @default(false)
  isVideo       Boolean             @default(false)
  views         Int                 @default(0)
  shares        Int                 @default(0)
  lovesCount    Int                 @default(0)
  firesCount    Int                 @default(0)
  wowsCount     Int                 @default(0)
  commentsCount Int                 @default(0)
  isFeatured    Boolean             @default(false)
  isHidden      Boolean             @default(false)
  visibility    ExploreVisibility   @default(PUBLIC)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments      ExploreComment[]
  bookmarks     ExploreBookmark[]

  @@index([userId])
  @@index([isHidden])
  @@index([visibility])
  @@index([isReel])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([views])
}

model ExploreComment {
  id        String      @id @default(uuid())
  postId    String
  userId    String
  userName  String
  text      String
  createdAt DateTime    @default(now())
  post      ExplorePost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
}

model ExploreBookmark {
  id        String      @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime    @default(now())
  post      ExplorePost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

enum ExploreVisibility {
  PUBLIC
  FOLLOWERS
  PRIVATE
}

// ================================
// Name Icons System (أيقونات بجانب الاسم)
// ================================

model NameIcon {
  id          String   @id @default(uuid())
  name        String   @unique // crown, fire, diamond, etc.
  displayName String   // التاج الملكي
  assetPath   String   // assets/name_icons/crown.gif
  price       Int      @default(80000)
  durationDays Int     @default(30) // مدة الصلاحية بالأيام
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userIcons   UserNameIcon[]
  
  @@index([isActive])
  @@index([sortOrder])
}

model UserNameIcon {
  id         String   @id @default(uuid())
  userId     String
  iconId     String
  expiresAt  DateTime
  isActive   Boolean  @default(true) // هل مفعلة حالياً
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  icon       NameIcon @relation(fields: [iconId], references: [id], onDelete: Cascade)
  
  @@unique([userId, iconId])
  @@index([userId])
  @@index([iconId])
  @@index([expiresAt])
  @@index([isActive])
}

// نظام الطعون/الاستئناف
model Appeal {
  id           String       @id @default(uuid())
  userId       String
  type         AppealType   @default(BAN_APPEAL)
  reason       String       // سبب الطعن من المستخدم
  status       AppealStatus @default(PENDING)
  response     String?      // رد المشرف
  reviewedBy   String?      // ID المشرف الذي راجعه
  reviewedAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

enum AppealType {
  BAN_APPEAL       // طعن على الحظر
  MUTE_APPEAL      // طعن على الكتم
  WARNING_APPEAL   // طعن على التحذير
  OTHER            // أخرى
}

enum AppealStatus {
  PENDING          // قيد المراجعة
  APPROVED         // تمت الموافقة
  REJECTED         // مرفوض
  IN_REVIEW        // جاري المراجعة
}
