generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                                                 String            @id @default(uuid())
  numericId                                          BigInt            @unique @default(autoincrement())
  email                                              String            @unique
  passwordHash                                       String?
  googleId                                           String?           @unique
  authProvider                                       AuthProvider      @default(EMAIL)
  username                                           String            @unique
  displayName                                        String
  avatar                                             String?
  bio                                                String?
  role                                               UserRole          @default(USER)
  status                                             UserStatus        @default(ACTIVE)
  isVIP                                              Boolean           @default(false)
  vipExpiresAt                                       DateTime?
  emailVerified                                      Boolean           @default(false)
  lastLoginAt                                        DateTime?
  lastLoginIp                                        String?
  createdAt                                          DateTime          @default(now())
  updatedAt                                          DateTime          @updatedAt
  adminActions                                       AdminAction[]     @relation("AdminActor")
  actionsReceived                                    AdminAction[]     @relation("AdminTarget")
  following                                          Follow[]          @relation("Follower")
  followers                                          Follow[]          @relation("Following")
  giftsReceived                                      GiftSend[]        @relation("GiftReceiver")
  giftsSent                                          GiftSend[]        @relation("GiftSender")
  sentMessages                                       Message[]         @relation("MessageSender")
  notifications                                      Notification[]
  refreshTokens                                      RefreshToken[]
  reportsReceived                                    Report[]          @relation("ReportedUser")
  reportsMade                                        Report[]          @relation("Reporter")
  reportsResolved                                    Report[]          @relation("ReportResolver")
  ownedRooms                                         Room[]            @relation("RoomOwner")
  roomMemberships                                    RoomMember[]
  wallet                                             Wallet?
  friend_requests_friend_requests_from_user_idToUser friend_requests[] @relation("friend_requests_from_user_idToUser")
  friend_requests_friend_requests_to_user_idToUser   friend_requests[] @relation("friend_requests_to_user_idToUser")
  friendships_friendships_user1_idToUser             friendships[]     @relation("friendships_user1_idToUser")
  friendships_friendships_user2_idToUser             friendships[]     @relation("friendships_user2_idToUser")
  // Private Messages
  sentPrivateMessages                                PrivateMessage[]  @relation("PrivateMessageSender")
  receivedPrivateMessages                            PrivateMessage[]  @relation("PrivateMessageReceiver")
  // Block System
  blockedUsers                                       UserBlock[]       @relation("Blocker")
  blockedByUsers                                     UserBlock[]       @relation("Blocked")
  // Device Tokens
  deviceTokens                                       DeviceToken[]
  // Agent Relations
  agentRequests                                      AgentRequest[]
  agent                                              Agent?

  @@index([email])
  @@index([googleId])
  @@index([username])
  @@index([status])
  @@index([createdAt])
  @@index([numericId])
  @@index([isVIP, vipExpiresAt])
}

model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     String
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Room {
  id                  String       @id @default(uuid())
  name                String
  description         String?
  avatar              String?
  type                RoomType     @default(PUBLIC)
  status              RoomStatus   @default(ACTIVE)
  ownerId             String
  maxMembers          Int          @default(100)
  currentMembers      Int          @default(0)
  isPasswordProtected Boolean      @default(false)
  passwordHash        String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  giftsSent           GiftSend[]
  messages            Message[]
  reports             Report[]
  owner               User         @relation("RoomOwner", fields: [ownerId], references: [id])
  members             RoomMember[]

  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model RoomMember {
  id          String     @id @default(uuid())
  roomId      String
  userId      String
  role        MemberRole @default(MEMBER)
  isMuted     Boolean    @default(false)
  mutedUntil  DateTime?
  isBanned    Boolean    @default(false)
  bannedUntil DateTime?
  joinedAt    DateTime   @default(now())
  leftAt      DateTime?
  room        Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@index([role])
  @@index([isBanned, bannedUntil])
  @@index([isMuted, mutedUntil])
}

model Message {
  id         String      @id @default(uuid())
  roomId     String
  senderId   String
  type       MessageType @default(TEXT)
  content    String
  metadata   Json?
  giftSendId String?     @unique
  isDeleted  Boolean     @default(false)
  deletedAt  DateTime?
  deletedBy  String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  giftSend   GiftSend?   @relation(fields: [giftSendId], references: [id])
  room       Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender     User        @relation("MessageSender", fields: [senderId], references: [id])

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([roomId, createdAt])
  @@index([isDeleted])
}

model Gift {
  id           String     @id @default(uuid())
  name         String
  description  String?
  type         GiftType   @default(STANDARD)
  imageUrl     String
  animationUrl String?
  videoUrl     String?
  price        Int
  isActive     Boolean    @default(true)
  sortOrder    Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  giftSends    GiftSend[]

  @@index([type])
  @@index([isActive])
  @@index([sortOrder])
}

model GiftSend {
  id             String   @id @default(uuid())
  idempotencyKey String   @unique
  giftId         String
  senderId       String
  receiverId     String
  roomId         String?
  quantity       Int      @default(1)
  totalPrice     Int
  message        String?
  createdAt      DateTime @default(now())
  gift           Gift     @relation(fields: [giftId], references: [id])
  receiver       User     @relation("GiftReceiver", fields: [receiverId], references: [id])
  room           Room?    @relation(fields: [roomId], references: [id])
  sender         User     @relation("GiftSender", fields: [senderId], references: [id])
  chatMessage    Message?

  @@index([senderId])
  @@index([receiverId])
  @@index([roomId])
  @@index([giftId])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  balance      Int                 @default(0)
  diamonds     Int                 @default(0)
  version      Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
}

model WalletTransaction {
  id            String            @id @default(uuid())
  walletId      String
  type          TransactionType
  status        TransactionStatus @default(COMPLETED)
  amount        Int
  balanceBefore Int
  balanceAfter  Int
  referenceType String?
  referenceId   String?
  description   String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  wallet        Wallet            @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

model AdminAction {
  id        String          @id @default(uuid())
  actorId   String
  targetId  String?
  action    AdminActionType
  reason    String?
  details   Json?
  ipAddress String?
  createdAt DateTime        @default(now())
  actor     User            @relation("AdminActor", fields: [actorId], references: [id])
  target    User?           @relation("AdminTarget", fields: [targetId], references: [id])

  @@index([actorId])
  @@index([targetId])
  @@index([action])
  @@index([createdAt])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Report {
  id             String       @id @default(uuid())
  reporterId     String
  reportedUserId String?
  reportedRoomId String?
  type           ReportType
  status         ReportStatus @default(PENDING)
  reason         String
  details        String?
  resolvedById   String?
  resolution     String?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  reportedRoom   Room?        @relation(fields: [reportedRoomId], references: [id])
  reportedUser   User?        @relation("ReportedUser", fields: [reportedUserId], references: [id])
  reporter       User         @relation("Reporter", fields: [reporterId], references: [id])
  resolvedBy     User?        @relation("ReportResolver", fields: [resolvedById], references: [id])

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([reportedRoomId])
  @@index([status])
  @@index([createdAt])
}

model AgentRequest {
  id              String             @id @default(uuid())
  userId          String
  fullName        String
  country         String
  province        String
  region          String
  email           String
  phone           String
  message         String?
  status          AgentRequestStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  expiresAt       DateTime           @default(dbgenerated("(now() + '7 days'::interval)"))
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([expiresAt])
}

model Agent {
  id        String      @id @default(uuid())
  userId    String      @unique
  fullName  String
  country   String
  province  String
  region    String
  phone     String
  status    AgentStatus @default(ACTIVE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([country])
  @@index([createdAt])
}

model friend_requests {
  id                                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  from_user_id                            String
  to_user_id                              String
  status                                  String?   @default("pending") @db.VarChar(20)
  created_at                              DateTime? @default(now()) @db.Timestamp(6)
  updated_at                              DateTime? @default(now()) @db.Timestamp(6)
  User_friend_requests_from_user_idToUser User      @relation("friend_requests_from_user_idToUser", fields: [from_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User_friend_requests_to_user_idToUser   User      @relation("friend_requests_to_user_idToUser", fields: [to_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([from_user_id, to_user_id])
  @@index([from_user_id, status], map: "idx_friend_requests_from_user")
  @@index([to_user_id, status], map: "idx_friend_requests_to_user")
}

model friendships {
  id                              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user1_id                        String
  user2_id                        String
  created_at                      DateTime? @default(now()) @db.Timestamp(6)
  User_friendships_user1_idToUser User      @relation("friendships_user1_idToUser", fields: [user1_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User_friendships_user2_idToUser User      @relation("friendships_user2_idToUser", fields: [user2_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user1_id, user2_id])
  @@index([user1_id], map: "idx_friendships_user1")
  @@index([user2_id], map: "idx_friendships_user2")
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum RoomType {
  PUBLIC
  PRIVATE
  VIP
}

enum RoomStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum MemberRole {
  MEMBER
  MODERATOR
  ADMIN
  OWNER
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  GIFT
  SYSTEM
}

enum GiftType {
  STANDARD
  ANIMATED
  VIDEO_VIP
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  GIFT_SENT
  GIFT_RECEIVED
  PURCHASE
  REFUND
  ADMIN_ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum AdminActionType {
  USER_BANNED
  USER_SUSPENDED
  USER_UNBANNED
  ROOM_CLOSED
  ROOM_SUSPENDED
  GIFT_CREATED
  GIFT_UPDATED
  WALLET_ADJUSTED
  SETTINGS_CHANGED
}

enum NotificationType {
  GIFT_RECEIVED
  NEW_FOLLOWER
  ROOM_INVITE
  SYSTEM_MESSAGE
  MENTION
  LIKE
  COMMENT
}

enum ReportType {
  SPAM
  HARASSMENT
  INAPPROPRIATE_CONTENT
  FAKE_ACCOUNT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum AgentRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ================================
// Private Messaging System
// ================================

model PrivateMessage {
  id          String               @id @default(uuid())
  senderId    String
  receiverId  String
  type        PrivateMessageType   @default(TEXT)
  content     String
  metadata    Json?
  status      PrivateMessageStatus @default(SENT)
  isDeleted   Boolean              @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  deliveredAt DateTime?
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  sender      User                 @relation("PrivateMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User                 @relation("PrivateMessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([senderId, receiverId])
  @@index([receiverId, status])
  @@index([createdAt])
}

enum PrivateMessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  GIFT
}

enum PrivateMessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ================================
// User Block System
// ================================

model UserBlock {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  reason    String?
  createdAt DateTime @default(now())
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// ================================
// Device Tokens for Push Notifications
// ================================

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  Platform @default(ANDROID)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, isActive])
}

enum Platform {
  ANDROID
  IOS
  WEB
}
